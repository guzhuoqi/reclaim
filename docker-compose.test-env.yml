services:
  attestor-core:
    build:
      context: ./attestor-core
      dockerfile: ./attestor.dockerfile
      args:
        # å¦‚éœ€ä»ç§æœ‰ Git ä»“åº“è·å–ä¾èµ–ï¼Œå¯åœ¨æœ¬åœ°å¯¼å‡º GL_TOKEN ç¯å¢ƒå˜é‡åæ„å»º
        GL_TOKEN: ${GL_TOKEN:-}
    volumes:
      # æŒ‚è½½ zk ç”µè·¯æ–‡ä»¶ç›®å½•ï¼Œæ„å»ºæ—¶ç”Ÿæˆçš„ç”µè·¯æ–‡ä»¶ä¼šå­˜å‚¨åœ¨è¿™é‡Œ
      - zk_circuits:/app/node_modules/@reclaimprotocol/zk-symmetric-crypto/resources
      # æŒ‚è½½æµè§ˆå™¨èµ„æºç›®å½•ï¼Œç”¨äºå­˜å‚¨æ„å»ºåçš„ zk æ–‡ä»¶
      - zk_circuits:/app/browser/resources
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=debug  # å¢åŠ æ—¥å¿—çº§åˆ«ç”¨äºè°ƒè¯•
      - ATTESTOR_PORT=8001
      - DISABLE_BGP_CHECKS=1
      - PRIVATE_KEY=${PRIVATE_KEY:-0x0123788edad59d7c013cdc85e4372f350f828e2cec62d9a2de4560e69aec7f89}
      # æ—¶åŒºé…ç½® - è®¾ç½®ä¸ºé¦™æ¸¯æ—¶åŒºä»¥åŒ¹é…é“¶è¡ŒæœåŠ¡å™¨
      - TZ=Asia/Hong_Kong
      # ZK ç›¸å…³é…ç½®
      - ZK_CONCURRENCY=1  # é™ä½å¹¶å‘é¿å…å†…å­˜é—®é¢˜
      - CONNECTION_TIMEOUT_MS=120000  # å¢åŠ è¿æ¥è¶…æ—¶åˆ°2åˆ†é’Ÿ
      # Node.js å†…å­˜é…ç½®
      - NODE_OPTIONS=--max-old-space-size=4096 --no-warnings
    # å†…å­˜é™åˆ¶é…ç½®ï¼ˆå¦‚æœ Docker Compose ç‰ˆæœ¬æ”¯æŒï¼‰
    mem_limit: 6g
    memswap_limit: 6g
    ports:
      - "18001:8001"
    restart: unless-stopped

  mitm:
    build:
      context: ./
      dockerfile: ./mitmproxy2swagger/mitmproxy_addons/Dockerfile
      args:
        # ç¡®ä¿åœ¨é•œåƒæ„å»ºé˜¶æ®µå®Œæˆ attestor-core çš„å®‰è£…ä¸æ„å»º
        SKIP_ATTESTOR_BUILD: "false"
        USE_PREBUILT_LIB: "false"
    working_dir: /opt/reclaim/mitmproxy2swagger/mitmproxy_addons
    volumes:
      # ä»…å…±äº«è¿è¡ŒæœŸæ•°æ®ï¼ˆä¼šè¯ã€ç´¢å¼•ã€attestor_dbã€æ—¥å¿—ï¼‰ï¼Œä¸å…±äº«æºç 
      - mitm_data:/opt/reclaim/mitmproxy2swagger/mitmproxy_addons/data
      # å…±äº« main-flow çš„ data ç›®å½•ï¼Œä¾› provider_query.py è®¿é—®
      - mitm_data:/app/main-flow/data
    environment:
      - PYTHONUNBUFFERED=1
      # Force addon to use local Node.js script mode
      - USE_WSS_ATTESTOR=false
      - ATTESTOR_HOST_PORT=local
      # æŒ‡å®š main-flow æ•°æ®ç›®å½•è·¯å¾„
      - MAIN_FLOW_DATA_DIR=/app/main-flow/data
      # ğŸ”§ é“¶è¡ŒHTTPç‰ˆæœ¬æ§åˆ¶ç¯å¢ƒå˜é‡
      - HSBC_HTTP_VERSION=${HSBC_HTTP_VERSION:-http1.1}
      - CMB_HTTP_VERSION=${CMB_HTTP_VERSION:-auto}
      - DEFAULT_HTTP_VERSION=${DEFAULT_HTTP_VERSION:-auto}
    depends_on:
      - attestor-core
    ports:
      - "31080:8080"
      - "8082:8082"
      - "8083:8083"
    restart: unless-stopped

  mainflow:
    build:
      context: ./
      dockerfile: ./mitmproxy2swagger/main-flow/Dockerfile
    working_dir: /app/main-flow
    volumes:
      # ä¸ mitm å…±äº« data ç›®å½•ï¼Œä½¿ mainflow å†™å…¥çš„ task_sessions è¢« mitm è¯»å–
      - mitm_data:/app/mitmproxy_addons/data
      # å…±äº« main-flow çš„ data ç›®å½•
      - mitm_data:/app/main-flow/data
    environment:
      - API_SERVER_HOST=0.0.0.0
      - API_SERVER_PORT=8000
      - MITM_HOST=mitm
      - MITM_PORT=8083
      - PYTHONPATH=/app
    ports:
      - "8000:8000"
    depends_on:
      - mitm
    restart: unless-stopped

networks:
  default:
    name: reclaim-test-env

volumes:
  mitm_data:
    driver: local
  mainflow_data:
    driver: local
  zk_circuits:
    driver: local


