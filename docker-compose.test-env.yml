version: "3.9"

services:
  attestor:
    build:
      context: ./attestor-core
      dockerfile: ./attestor.dockerfile
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=info
      - ATTESTOR_PORT=8001
      - DISABLE_BGP_CHECKS=1
      - PRIVATE_KEY=${PRIVATE_KEY:-0x0123788edad59d7c013cdc85e4372f350f828e2cec62d9a2de4560e69aec7f89}
    ports:
      - "18001:8001"
    restart: unless-stopped

  mitm:
    build:
      context: ./
      dockerfile: ./mitmproxy2swagger/mitmproxy_addons/Dockerfile
    working_dir: /opt/reclaim/mitmproxy2swagger/mitmproxy_addons
    volumes:
      - ./mitmproxy2swagger:/opt/reclaim/mitmproxy2swagger
    environment:
      - PYTHONUNBUFFERED=1
      # Force addon to use local Node.js script mode
      - USE_WSS_ATTESTOR=false
      - ATTESTOR_HOST_PORT=local
    depends_on:
      - attestor
    ports:
      - "8080:8080"
      - "8082:8082"
    restart: unless-stopped

  mainflow:
    build:
      context: ./
      dockerfile: ./mitmproxy2swagger/main-flow/Dockerfile
    working_dir: /app/main-flow
    environment:
      - API_SERVER_HOST=0.0.0.0
      - API_SERVER_PORT=8000
      - MITM_HOST=mitm
      - MITM_PORT=8082
    ports:
      - "8000:8000"
    depends_on:
      - mitm
    volumes:
      - ./mitmproxy2swagger/main-flow:/app/main-flow
      - ./mitmproxy2swagger/mitmproxy_addons:/app/mitmproxy_addons
    restart: unless-stopped

networks:
  default:
    name: reclaim-test-env


